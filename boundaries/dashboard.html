<!DOCTYPE html>
<html>
<head>
    <title>Timeslots List</title>
    <style>
        html, body {
            padding: 0;
            margin: 0;
            font-family: Arial, Helvetica, sans-serif;
        }
        #timeslotList {
            list-style-type: none;
        }
        #timeslotList li {
            width: 50%;
            background: #cecece;
            margin-bottom: 3px;
            padding: 5px 8px;
        }
        #weeksWrap {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
            margin-top: 10px;
        }
        #weekLine {
            display: flex;
            flex-direction: row;
        }
        #weekItem {
            display: flex;
            flex-direction: column;
            width: 140px;
            height: 188px;
            border: 1px solid black;
            border-radius: 5px;
            margin-right: 10px;
            margin-bottom: 7px;
            padding: 6px 10px;
        }
        #opButton {
            text-align: center;
            margin-top: 10px;
            margin-bottom: 15px;
        }
        #opText {
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>Timeslots List</h1>
    <input type="text" id="searchInput" placeholder="Search by Timeslot ID">
    <button id="searchButton">Search</button>
    <div id="weeksWrap"></div>
    <div id="timeslotDetails" style="display: none;"></div>

    <script>
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const timeslotList = document.getElementById('weeksWrap');
        const timeslotDetails = document.getElementById('timeslotDetails');

        // Fetch and display the list of timeslots
        fetch('/timeslots')
            .then(response => response.json())
            .then(timeslots => {
                fetch('/bids')
                    .then(response => response.json())
                    .then(bids => {
                        const readyData = timeslots.map(timeslot => {
                            const accBid = bids.filter(bid => bid.bidOn == timeslot.id && bid.bidBy == window.location.href.substring(window.location.href.lastIndexOf('/') + 1));
                            return({
                                ...timeslot,
                                bids: accBid
                            });
                        });
                        const split = readyData.reduce((all,one,i) => {
                            const ch = Math.floor(i/7); 
                            all[ch] = [].concat((all[ch]||[]),one); 
                            return all;
                        }, []);
                        split.forEach(el => {
                            const listItem = document.createElement('div');
                            listItem.id = 'weekLine';
                            el.forEach(timeslot => {
                                const item = document.createElement('div');
                                item.id = 'weekItem';
                                item.innerHTML = `<span><b>Shift</b>: ${timeslot.timeframe}</span><span><b>Date</b>: ${timeslot.date}<span>`;
                                listItem.append(item);
                                if(timeslot.bids.length > 0) {
                                    timeslot.bids.forEach(bid => {
                                        const status = document.createElement('span');
                                        status.id = 'opText';
                                        status.innerText = bid.approved > 0 ? 'approved!' : bid.approved < 0 ? 'rejected :(' : 'under review...';
                                        item.appendChild(status);
                                        if (bid.approved == 0) {
                                            const removeButton = document.createElement('button');
                                            removeButton.id = 'opButton';
                                            removeButton.innerText = 'Remove Bid';
                                            removeButton.bidId = bid.id;
                                            removeButton.onclick = handleRemoveBidding;
                                            item.appendChild(removeButton);
                                        }
                                    });
                                } else {
                                    const bidOnButt = document.createElement('button');
                                    bidOnButt.innerText = 'Bid on this slot';
                                    bidOnButt.tid = timeslot.id;
                                    bidOnButt.uid = window.location.href.substring(window.location.href.lastIndexOf('/') + 1);
                                    bidOnButt.id = 'opButton';
                                    bidOnButt.onclick = handleBidding;
                                    item.appendChild(bidOnButt);
                                }
                            });
                            timeslotList.appendChild(listItem);
                        });
                    })
                    .catch(error => {
                        timeslotList.innerHTML = 'Error fetching bids';
                    });
            })
            .catch(error => {
                timeslotList.innerHTML = 'Error fetching timeslots';
            });

        // Function to show timeslot details
        const showTimeslotDetails = (timeslot) => {
            timeslotDetails.style.display = 'block';
            timeslotList.style.display = 'none';
            timeslotDetails.innerHTML = `Timeframe: ${timeslot.timeframe}, Date: ${timeslot.date}`;
        };

        const handleBidding = (event) => {
            event.preventDefault();

            // Get the updated bid data from the form
            const updatedBidData = {
                bidOn: event.target.tid,
                bidBy: event.target.uid,
                approved: 0,
                reviewedBy: 0,
            };

            // Send the POST request to create the bid
            fetch('/bids', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updatedBidData),
            })
            .then(response => {
                if (response.status === 200) {
                  if(alert('Bidded successfully')){}
                  else window.location.reload();
                } else {
                  if(alert('Error bidding')){}
                  else window.location.reload();
                }
            })
            .catch(error => {
                console.error('Network error:', error);
            });
        };

        const handleRemoveBidding = (event) => {
            event.preventDefault();

            // Send the DELETE request to delete the bid
            fetch(`/bids/${event.target.bidId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => {
                if (response.status === 204) {
                  if(alert('Bid removed successfully')){}
                  else window.location.reload();
                } else {
                  if(alert('Error removing bid')){}
                  else window.location.reload();
                }
            })
            .catch(error => {
                console.error('Network error:', error);
            });
        };

        // Function to handle search
        const handleSearch = () => {
            const timeslotId = parseInt(searchInput.value, 10);

            // If a valid number is entered, fetch and display timeslot details
            if (!isNaN(timeslotId)) {
                fetch(`/timeslots/${timeslotId}`)
                    .then(response => {
                        if (response.status === 200) {
                            return response.json();
                        } else {
                            throw new Error('Timeslot not found');
                        }
                    })
                    .then(timeslot => {
                        showTimeslotDetails(timeslot);
                    })
                    .catch(error => {
                        timeslotDetails.innerHTML = 'No timeslot found with this ID';
                    });
            } else {
                timeslotDetails.style.display = 'none';
                timeslotList.style.display = 'block';
            }
        };

        // Event listener for the search button
        searchButton.addEventListener('click', handleSearch);

        // Event listener for Enter key in the search input
        searchInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                handleSearch();
            }
        });
    </script>
</body>
</html>
